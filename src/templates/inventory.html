{% extends "base.html" %}

{% block title %}Inventario — Inventario Coca-Cola{% endblock %}

{% block content %}
  <div class="card">
    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:12px;">
      <div>
        <h2 style="margin:0 0 6px 0;font-size:clamp(20px, 5vw, 28px);">Inventario</h2>
        <div class="small">Lista de artículos disponibles</div>
      </div>
      <div class="controls" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;">
        <input id="inventory_search_input" type="search" inputmode="search" placeholder="Buscar..." style="padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);grid-column:1/3;font-size:16px;-webkit-appearance:none;appearance:none;box-sizing:border-box;">
        <button id="inventory_search_btn" class="btn" style="min-height:44px;font-size:14px;">Buscar</button>
        <a class="btn" href="{{ url_for('add_inventory') }}" style="text-align:center;display:flex;align-items:center;justify-content:center;min-height:44px;font-size:14px;">+ Artículo</a>
        <a class="btn secondary" href="{{ url_for('index') }}" style="text-align:center;display:flex;align-items:center;justify-content:center;min-height:44px;font-size:14px;grid-column:1/3;">Volver</a>
      </div>
    </div>

    {% if inventory_list %}
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
      <table id="inventory-table" style="width:100%;border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left;padding:10px;border-bottom:2px solid #e2e8f0;font-size:clamp(12px,2vw,14px);">Código</th>
            <th style="text-align:left;padding:10px;border-bottom:2px solid #e2e8f0;font-size:clamp(12px,2vw,14px);">Producto</th>
            <th style="text-align:center;padding:10px;border-bottom:2px solid #e2e8f0;font-size:clamp(12px,2vw,14px);">Est.</th>
            <th style="text-align:center;padding:10px;border-bottom:2px solid #e2e8f0;font-size:clamp(12px,2vw,14px);">Piso</th>
            <th style="text-align:center;padding:10px;border-bottom:2px solid #e2e8f0;font-size:clamp(12px,2vw,14px);">Pac.</th>
            <th style="text-align:center;padding:10px;border-bottom:2px solid #e2e8f0;font-size:clamp(12px,2vw,14px);">Acc.</th>
          </tr>
        </thead>
        <tbody id="inventory-tbody">
        {% for it in inventory_list %}
          <tr style="border-bottom:1px solid #e2e8f0;">
            <td class="inv-code" style="padding:10px;word-break:break-word;font-size:14px;">{{ it.code }}</td>
            <td class="inv-product" style="padding:10px;word-break:break-word;font-size:14px;">{{ it.product }}</td>
            <td style="padding:10px;text-align:center;font-size:14px;">{{ it.shelves }}</td>
            <td style="padding:10px;text-align:center;font-size:14px;">{{ it.floors }}</td>
            <td style="padding:10px;text-align:center;font-size:14px;">{{ it.packs }}</td>
            <td style="padding:10px;text-align:center;">
            <div class="actions" style="display:flex;gap:4px;justify-content:center;flex-wrap:wrap;">
              <a class="btn secondary" href="{{ url_for('edit_inventory', id=it._id) }}" style="padding:6px 10px;font-size:12px;min-height:auto;">✎</a>
              <form method="post" action="{{ url_for('delete_inventory', id=it._id) }}" style="display:inline;margin:0;">
                <button class="btn danger" type="submit" onclick="return confirm('¿Eliminar?')" style="padding:6px 10px;font-size:12px;min-height:auto;">✕</button>
              </form>
            </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>

      <!-- pagination controls -->
      <div id="inventory-pagination" style="display:flex;gap:6px;align-items:center;margin-top:12px;flex-wrap:wrap;justify-content:center;padding:8px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;"></div>
    {% else %}
      <p class="muted">No hay registros de inventario.</p>
    {% endif %}
  </div>

  <script>
  (function(){
    const ROWS_PER_PAGE = 8;
    const tbody = document.getElementById('inventory-tbody');
    if (!tbody) return;

    let allRows = Array.from(tbody.querySelectorAll('tr'));
    let filteredRows = allRows.slice();
    let currentPage = 1;

    const paginationDiv = document.getElementById('inventory-pagination');
    const searchInput = document.getElementById('inventory_search_input');
    const searchBtn = document.getElementById('inventory_search_btn');

    function renderPage(page){
      tbody.innerHTML = '';
      const start = (page - 1) * ROWS_PER_PAGE;
      const slice = filteredRows.slice(start, start + ROWS_PER_PAGE);
      slice.forEach(r => tbody.appendChild(r));
      currentPage = page;
      renderPagination();
      tbody.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
    }

    function renderPagination(){
      paginationDiv.innerHTML = '';
      const totalPages = Math.max(1, Math.ceil(filteredRows.length / ROWS_PER_PAGE));
      const prev = document.createElement('button');
      prev.className = 'btn';
      prev.textContent = '‹';
      prev.style.minHeight = '44px';
      prev.disabled = currentPage <= 1;
      prev.addEventListener('click', ()=> renderPage(currentPage - 1));
      paginationDiv.appendChild(prev);

      const maxButtons = window.innerWidth < 768 ? 3 : 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons/2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      if (endPage - startPage < maxButtons - 1){
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      for (let p = startPage; p <= endPage; p++){
        const b = document.createElement('button');
        b.className = 'btn' + (p === currentPage ? ' active' : '');
        b.textContent = p;
        b.style.minHeight = '44px';
        b.style.minWidth = '44px';
        b.addEventListener('click', ()=> renderPage(p));
        paginationDiv.appendChild(b);
      }

      const next = document.createElement('button');
      next.className = 'btn';
      next.textContent = '›';
      next.style.minHeight = '44px';
      next.disabled = currentPage >= totalPages;
      next.addEventListener('click', ()=> renderPage(currentPage + 1));
      paginationDiv.appendChild(next);

      const info = document.createElement('span');
      info.style.marginLeft = '10px';
      info.style.fontSize = '12px';
      info.className = 'small muted';
      info.textContent = `${filteredRows.length} resultado(s)`;
      paginationDiv.appendChild(info);
    }

    function normalizeText(s){ return String(s || '').trim().toLowerCase(); }

    function applyFilter(q){
      if (!q){
        filteredRows = allRows.slice();
      } else {
        filteredRows = allRows.filter(row=>{
          const code = normalizeText(row.querySelector('.inv-code')?.textContent);
          const prod = normalizeText(row.querySelector('.inv-product')?.textContent);
          return code.includes(q) || prod.includes(q);
        });
      }
      renderPage(1);
    }

    searchBtn.addEventListener('click', function(e){
      e.preventDefault();
      const q = normalizeText(searchInput.value);
      applyFilter(q);
      if (filteredRows.length){
        const firstRow = tbody.querySelector('tr');
        if (firstRow){
          firstRow.classList.add('highlight');
          firstRow.scrollIntoView({behavior:'smooth', block:'nearest'});
        }
      }
    });

    searchInput.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        e.preventDefault();
        searchBtn.click();
      }
    });

    searchInput.addEventListener('input', function(e){
      const q = normalizeText(searchInput.value);
      applyFilter(q);
    });

    renderPage(1);

    const style = document.createElement('style');
    style.textContent = '.highlight{background: #fff3cd;} .btn.active{background:#0b74de;color:#fff;} @media(max-width:768px){.btn{font-size:14px;padding:8px 10px;}}';
    document.head.appendChild(style);
  })();
  </script>
{% endblock %}